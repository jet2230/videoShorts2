<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Shorts Creator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0f0f0f;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #252525;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --accent: #ff0050;
            --accent-hover: #ff2060;
            --border: #333;
            --success: #2ba640;
            --error: #ff4444;
            --warning: #ffaa00;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 30px;
        }

        h1 {
            font-size: 24px;
            font-weight: 600;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            background: var(--bg-tertiary);
        }

        .status-badge.online {
            background: var(--success);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 1px solid var(--border);
        }

        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .tab:hover {
            color: var(--text-primary);
        }

        .tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        input[type="text"],
        input[type="url"],
        input[type="file"],
        select {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: var(--accent);
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Cards */
        .card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        /* Folder List */
        .folder-list {
            display: grid;
            gap: 12px;
        }

        .folder-item {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .folder-item:hover {
            border-color: var(--accent);
        }

        .folder-item.selected {
            border-color: var(--accent);
            background: rgba(255, 0, 80, 0.1);
        }

        .folder-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .folder-number {
            font-weight: 600;
            color: var(--accent);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .play-video-btn {
            background: rgba(255, 0, 80, 0.2);
            border: 1px solid rgba(255, 0, 80, 0.5);
            color: var(--accent);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 12px;
            line-height: 1;
        }

        .play-video-btn:hover {
            background: rgba(255, 0, 80, 0.4);
            transform: scale(1.1);
        }

        .library-video-player {
            width: 100%;
            max-height: 75vh;
            display: block;
        }

        .folder-name {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .folder-meta {
            display: flex;
            gap: 16px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* Themes List */
        .themes-list {
            display: grid;
            gap: 12px;
        }

        .theme-item {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            cursor: pointer;
            transition: border-color 0.2s, box-shadow 0.2s;
            user-select: none;
        }

        .theme-item:hover {
            border-color: #00bfff;
            box-shadow: 0 0 10px rgba(0, 191, 255, 0.3);
        }

        .theme-checkbox {
            margin-top: 4px;
            width: 18px;
            height: 18px;
            accent-color: var(--accent);
            pointer-events: none;
        }

        .theme-content {
            flex: 1;
        }

        .theme-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .theme-number {
            font-weight: 600;
            color: var(--accent);
        }

        .theme-duration {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .theme-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .theme-time {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .theme-created-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background: var(--success);
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            color: white;
        }

        .theme-created-badge::before {
            content: '‚úì';
        }

        .theme-play-btn {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background: var(--success);
            border: none;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            color: white;
            cursor: pointer;
            margin-top: 8px;
            transition: background 0.2s;
        }

        .theme-play-btn:hover {
            background: #238a36;
        }

        .theme-play-btn::before {
            content: '‚ñ∂';
            font-size: 8px;
        }

        .theme-header-row {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 6px;
        }

        /* Tooltip */
        .tooltip {
            position: fixed;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            max-width: 400px;
            word-break: break-all;
            display: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }

        .tooltip.show {
            display: block;
        }

        /* Video modal */
        .video-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .video-modal.show,
        #video-modal.show {
            display: flex;
        }

        .video-modal video {
            max-width: 90%;
            max-height: 90%;
            border-radius: 8px;
        }

        .video-modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .video-modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Shorts Grid */
        .shorts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .short-item {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            transition: transform 0.2s, border-color 0.2s;
            cursor: pointer;
        }

        .short-item:hover {
            transform: translateY(-4px);
            border-color: var(--accent);
        }

        .short-thumbnail {
            width: 100%;
            aspect-ratio: 9/16;
            background: var(--bg-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .short-thumbnail video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0.7;
            transition: opacity 0.3s;
        }

        .short-thumbnail:hover video {
            opacity: 1;
        }

        .short-thumbnail .play-icon {
            position: absolute;
            font-size: 48px;
            color: white;
            opacity: 0;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
            transition: opacity 0.3s, transform 0.3s;
            pointer-events: none;
        }

        .short-thumbnail:hover .play-icon {
            opacity: 0.9;
            transform: scale(1.1);
        }

        .short-thumbnail canvas {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .short-info {
            padding: 12px;
        }

        .short-title {
            font-weight: 600;
            margin-bottom: 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .short-meta {
            font-size: 12px;
            color: var(--text-secondary);
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .short-filename {
            font-family: monospace;
            font-size: 11px;
            color: var(--text-secondary);
        }

        .short-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .short-actions button {
            flex: 1;
            padding: 6px 12px;
            font-size: 12px;
            text-align: center;
        }

        .short-actions .btn-play {
            border-color: #2ba640;
            border: 2px solid #2ba640;
        }

        .short-actions .btn-download {
            border-color: #0066cc;
            border: 2px solid #0066cc;
        }

        .short-actions .btn-edit {
            border-color: #ffaa00;
            border: 2px solid #ffaa00;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Progress */
        .progress-container {
            display: none;
            margin-top: 20px;
        }

        .progress-container.active {
            display: block;
        }

        .progress-bar {
            height: 4px;
            background: var(--bg-tertiary);
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent);
            animation: progress 2s ease-in-out infinite;
        }

        @keyframes progress {
            0% { width: 0%; margin-left: 0; }
            50% { width: 50%; margin-left: 25%; }
            100% { width: 0%; margin-left: 100%; }
        }

        .progress-text {
            font-size: 14px;
            color: var(--text-secondary);
            text-align: center;
        }

        .progress-cancel {
            text-align: center;
            margin-top: 12px;
        }

        .btn-cancel {
            background: var(--error);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: background 0.2s;
            display: none;
        }

        .btn-cancel:hover {
            background: #cc0000;
        }

        /* Notifications */
        .notification {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .notification.show {
            display: block;
        }

        .notification.success {
            background: rgba(43, 166, 64, 0.2);
            border: 1px solid var(--success);
        }

        .notification.error {
            background: rgba(255, 68, 68, 0.2);
            border: 1px solid var(--error);
        }

        /* Video Modal */
        #video-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .video-modal-content {
            position: relative;
            width: 100%;
            max-width: 900px;
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .video-modal-close {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 68, 68, 0.2);
            border: 1px solid var(--error);
            color: var(--error);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            z-index: 10;
        }

        #video-modal video,
        #video-modal [data-video-modal-player] {
            width: 100%;
            max-height: 75vh;
            display: block;
            position: relative;
            z-index: 1;
        }

        .video-modal-close:hover {
            background: rgba(255, 68, 68, 0.4);
            transform: scale(1.1);
        }

        #video-modal video,
        #video-modal [data-video-modal-player] {
            width: 100%;
            max-height: 75vh;
            display: block;
        }

        /* Two column layout for themes */
        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 900px) {
            .two-column {
                grid-template-columns: 1fr;
            }
        }

        .actions-bar {
            display: flex;
            gap: 12px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .stats {
            display: flex;
            gap: 24px;
            margin-bottom: 20px;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 600;
            color: var(--accent);
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>YouTube Shorts Creator</h1>
            <span class="status-badge online">Server Online</span>
        </header>

        <div class="tabs">
            <button class="tab active" data-tab="library">Theme Library</button>
            <button class="tab" data-tab="add">Add Video</button>
            <button class="tab" data-tab="edit-shorts">Edit Shorts</button>
            <button class="tab" data-tab="settings">Settings</button>
        </div>

        <!-- Library Tab -->
        <div id="library-tab" class="tab-content active">
            <div class="card">
                <div class="card-title">Theme Library</div>
                <div class="folder-list" id="folder-list">
                    <div class="empty-state">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Add Video Tab -->
        <div id="add-tab" class="tab-content">
            <div class="card">
                <div class="card-title">Add New Video</div>

                <div class="form-group">
                    <label>YouTube URL</label>
                    <input type="url" id="url-input" placeholder="https://www.youtube.com/watch?v=...">
                </div>

                <div style="text-align: center; margin: 20px 0; color: var(--text-secondary);">OR</div>

                <div class="form-group">
                    <label>Local Video File</label>
                    <input type="file" id="file-input" accept="video/*">
                </div>

                <button class="btn btn-primary" id="process-btn">
                    Process Video
                </button>

                <div class="progress-container" id="process-progress">
                    <div class="progress-bar">
                        <div class="progress-fill"></div>
                    </div>
                    <div class="progress-text" id="process-text">Processing...</div>
                    <div class="progress-cancel">
                        <button class="btn-cancel" id="cancel-process-btn">Cancel</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings-tab" class="tab-content">
            <div class="card">
                <div class="card-title">Settings</div>

                <div class="form-group">
                    <label>Whisper Model</label>
                    <select id="setting-whisper-model">
                        <option value="tiny">Tiny (fastest)</option>
                        <option value="base">Base</option>
                        <option value="small">Small</option>
                        <option value="medium">Medium</option>
                        <option value="large">Large (best)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Whisper Language</label>
                    <select id="setting-whisper-language">
                        <option value="en">English</option>
                        <option value="ar">Arabic</option>
                        <option value="es">Spanish</option>
                        <option value="fr">French</option>
                        <option value="de">German</option>
                        <option value="auto">Auto-detect</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Video Output Directory</label>
                    <input type="text" id="setting-video-output-dir">
                </div>

                <div class="form-group">
                    <label>Aspect Ratio</label>
                    <select id="setting-video-aspect-ratio">
                        <option value="9:16">9:16 (Vertical/Shorts)</option>
                        <option value="16:9">16:9 (Horizontal)</option>
                        <option value="1:1">1:1 (Square)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="setting-ai-enabled">
                        Enable AI Theme Detection
                    </label>
                </div>

                <div class="form-group">
                    <label>AI Model</label>
                    <select id="setting-ai-model">
                        <option value="llama3">Llama 3</option>
                        <option value="mistral">Mistral</option>
                        <option value="gemma">Gemma</option>
                    </select>
                </div>

                <button class="btn btn-primary" id="save-settings-btn">Save Settings</button>
            </div>
        </div>

        <!-- Edit Shorts Tab -->
        <div id="edit-shorts-tab" class="tab-content">
            <div class="card">
                <div class="card-title">All Shorts</div>

                <div style="display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;">
                    <select id="shorts-folder-filter" style="flex: 1; min-width: 200px;">
                        <option value="">All Videos</option>
                    </select>
                    <input type="text" id="shorts-search" placeholder="Search shorts..." style="flex: 1; min-width: 200px;">
                    <button class="btn btn-secondary" id="refresh-shorts-btn">Refresh</button>
                </div>

                <div class="shorts-grid" id="shorts-grid">
                    <div class="empty-state">Loading shorts...</div>
                </div>
            </div>
        </div>

        <!-- Themes Panel (shown when folder selected) -->
        <div id="themes-panel" class="card" style="display: none;">
            <div class="two-column">
                <div>
                    <div class="card-title" id="selected-folder-title">Themes</div>
                    <div class="stats" id="folder-stats"></div>
                    <div class="themes-list" id="themes-list"></div>
                    <div class="actions-bar">
                        <button class="btn btn-secondary" id="select-all-btn" disabled>Select All</button>
                        <button class="btn btn-secondary" id="deselect-all-btn" disabled>Deselect All</button>
                        <button class="btn btn-secondary" id="regenerate-btn" disabled>Regenerate Themes</button>
                        <button class="btn btn-primary" id="create-shorts-btn" disabled>Create Shorts</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="progress-container" id="task-progress" style="display: none;">
            <div class="progress-bar">
                <div class="progress-fill"></div>
            </div>
            <div class="progress-text" id="task-progress-text">Processing...</div>
            <div class="progress-cancel">
                <button class="btn-cancel" id="cancel-task-btn">Cancel</button>
            </div>
        </div>

        <div class="notification" id="notification"></div>

        <!-- Tooltip for file path -->
        <div class="tooltip" id="tooltip"></div>

        <!-- Video modal -->
        <div class="video-modal" id="video-modal">
            <div class="video-modal-content">
                <button class="video-modal-close" id="video-modal-close">&times;</button>
                <video id="video-player" controls></video>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://127.0.0.1:5000/api';
        let selectedFolder = null;
        let currentTaskId = null;
        let taskCheckInterval = null;

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(`${tab.dataset.tab}-tab`).classList.add('active');

                // Hide themes panel when switching tabs
                document.getElementById('themes-panel').style.display = 'none';

                if (tab.dataset.tab === 'library') {
                    loadFolders();
                } else if (tab.dataset.tab === 'settings') {
                    loadSettings();
                } else if (tab.dataset.tab === 'edit-shorts') {
                    loadShorts();
                }
            });
        });

        // Load folders
        async function loadFolders() {
            try {
                const response = await fetch(`${API_BASE}/folders`);
                const folders = await response.json();

                const container = document.getElementById('folder-list');
                if (folders.length === 0) {
                    container.innerHTML = '<div class="empty-state">No videos found. Add one to get started!</div>';
                    return;
                }

                container.innerHTML = folders.map(folder => `
                    <div class="folder-item" data-folder="${folder.number}" data-video="${folder.video_file}" data-folder-name="${folder.name}" data-folder-path="${folder.name}">
                        <div class="folder-header">
                            <span class="folder-number">
                                #${folder.number}
                                <button class="play-video-btn" data-play-folder="${folder.name}" data-play-video="${folder.video_file}" title="Play video">‚ñ∂</button>
                            </span>
                            <span class="folder-name">${folder.name}</span>
                        </div>
                        <div class="folder-meta">
                            <span>${folder.video_file}</span>
                            ${folder.has_themes ? '<span>‚úì Themes</span>' : '<span>No themes</span>'}
                            ${folder.shorts_count > 0 ? `<span>${folder.shorts_count} shorts</span>` : ''}
                        </div>
                    </div>
                `).join('');

                // Add click handlers
                container.querySelectorAll('.folder-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        // Check if play button was clicked
                        if (e.target.classList.contains('play-video-btn')) {
                            const folderName = e.target.dataset.playFolder;
                            const videoFile = e.target.dataset.playVideo;
                            playFolderVideo(e, folderName, videoFile);
                            return;
                        }

                        // Regular folder selection
                        document.querySelectorAll('.folder-item').forEach(i => i.classList.remove('selected'));
                        item.classList.add('selected');
                        selectFolder(item.dataset.folder);
                    });
                });
            } catch (error) {
                showNotification('Error loading folders: ' + error.message, 'error');
            }
        }

        // Play folder video
        async function playFolderVideo(event, folderName, videoFile) {
            event.stopPropagation(); // Prevent folder selection

            // URL encode both folder name and filename to handle special characters
            const videoUrl = `/videos/${encodeURIComponent(folderName)}/${encodeURIComponent(videoFile)}`;
            console.log('Playing video:', videoUrl);

            // Use the existing video modal from the HTML
            const modal = document.getElementById('video-modal');
            const player = document.getElementById('video-player');

            if (!player) {
                showNotification('Error: Video player not found', 'error');
                return;
            }

            player.src = videoUrl;
            modal.classList.add('show');

            try {
                await player.play();
                console.log('Video playing successfully');
            } catch (error) {
                console.log('Autoplay prevented, user needs to click play:', error);
            }
        }

        // Select folder and load themes
        async function selectFolder(folderNumber) {
            selectedFolder = folderNumber;

            try {
                const response = await fetch(`${API_BASE}/folder/${folderNumber}/themes`);
                if (!response.ok) {
                    throw new Error('No themes found for this folder');
                }

                const data = await response.json();
                displayThemes(data);
            } catch (error) {
                showNotification(error.message, 'error');
                document.getElementById('themes-panel').style.display = 'none';
            }
        }

        // Load settings
        async function loadSettings() {
            try {
                const response = await fetch(`${API_BASE}/settings`);
                const settings = await response.json();

                document.getElementById('setting-whisper-model').value = settings.whisper.model;
                document.getElementById('setting-whisper-language').value = settings.whisper.language;
                document.getElementById('setting-video-output-dir').value = settings.video.output_dir;
                document.getElementById('setting-video-aspect-ratio').value = settings.video.aspect_ratio;
                document.getElementById('setting-ai-enabled').checked = settings.theme.ai_enabled;
                document.getElementById('setting-ai-model').value = settings.theme.ai_model;
            } catch (error) {
                showNotification('Error loading settings: ' + error.message, 'error');
            }
        }

        // Save settings
        document.getElementById('save-settings-btn').addEventListener('click', async () => {
            const settings = {
                whisper: {
                    model: document.getElementById('setting-whisper-model').value,
                    language: document.getElementById('setting-whisper-language').value,
                },
                video: {
                    output_dir: document.getElementById('setting-video-output-dir').value,
                    aspect_ratio: document.getElementById('setting-video-aspect-ratio').value,
                },
                theme: {
                    ai_enabled: document.getElementById('setting-ai-enabled').checked,
                    ai_model: document.getElementById('setting-ai-model').value,
                }
            };

            try {
                const response = await fetch(`${API_BASE}/settings`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });

                if (!response.ok) {
                    throw new Error('Failed to save settings');
                }

                showNotification('Settings saved successfully!', 'success');
            } catch (error) {
                showNotification('Error saving settings: ' + error.message, 'error');
            }
        });

        // Store shorts data globally
        let allShorts = [];

        // Load shorts
        async function loadShorts() {
            try {
                const response = await fetch(`${API_BASE}/shorts`);
                allShorts = await response.json();

                // Populate folder filter dropdown
                const folderFilter = document.getElementById('shorts-folder-filter');
                const folders = [...new Set(allShorts.map(s => s.folder))];

                // Save current selection
                const currentSelection = folderFilter.value;

                folderFilter.innerHTML = '<option value="">All Videos</option>' +
                    folders.map(folder => `<option value="${folder}">${folder.replace(/^\d+_/, '').replace(/_/g, ' ')}</option>`).join('');

                // Restore selection if still valid
                if (folders.includes(currentSelection)) {
                    folderFilter.value = currentSelection;
                }

                // Apply filters and display
                filterAndDisplayShorts();

            } catch (error) {
                showNotification('Error loading shorts: ' + error.message, 'error');
            }
        }

        // Filter and display shorts based on folder and search
        function filterAndDisplayShorts() {
            const folderFilter = document.getElementById('shorts-folder-filter').value;
            const searchTerm = document.getElementById('shorts-search').value.toLowerCase();

            // Filter shorts
            const filteredShorts = allShorts.filter(short => {
                const matchesFolder = !folderFilter || short.folder === folderFilter;
                const matchesSearch = !searchTerm ||
                    short.filename.toLowerCase().includes(searchTerm) ||
                    short.folder.toLowerCase().includes(searchTerm) ||
                    `theme ${short.theme_number}`.includes(searchTerm);

                return matchesFolder && matchesSearch;
            });

            const container = document.getElementById('shorts-grid');
            container.innerHTML = '';

            if (filteredShorts.length === 0) {
                container.innerHTML = '<div class="empty-state">No shorts found matching your filters.</div>';
                return;
            }

            // Create short items using DOM methods to avoid escaping issues
            filteredShorts.forEach(short => {
                const videoUrl = '/videos/' + short.url_path;
                const displayName = short.filename.replace(/_/g, ' ').replace('.mp4', '');
                const folderName = short.folder.replace(/^\d+_/, '').replace(/_/g, ' ');

                // Encode URL path components separately to handle all special characters
                const pathParts = videoUrl.split('/');
                const encodedPath = pathParts.map(part => encodeURIComponent(part)).join('/');

                const itemDiv = document.createElement('div');
                itemDiv.className = 'short-item';
                itemDiv.dataset.videoUrl = videoUrl;
                itemDiv.dataset.filename = short.filename;

                const thumbnail = document.createElement('div');
                thumbnail.className = 'short-thumbnail';

                const video = document.createElement('video');
                video.src = encodedPath;
                video.preload = 'metadata';
                video.muted = true;
                video.loop = true;
                video.playsInline = true;

                const playIcon = document.createElement('div');
                playIcon.className = 'play-icon';
                playIcon.textContent = '‚ñ∂';

                thumbnail.appendChild(video);
                thumbnail.appendChild(playIcon);

                const info = document.createElement('div');
                info.className = 'short-info';

                const title = document.createElement('div');
                title.className = 'short-title';
                title.textContent = displayName;
                title.title = displayName;

                const meta = document.createElement('div');
                meta.className = 'short-meta';
                meta.innerHTML = `
                    <span>üìÅ ${folderName}</span>
                    <span>üé¨ Theme ${short.theme_number}</span>
                    <span>üì¶ ${short.size} MB</span>
                `;

                const filename = document.createElement('div');
                filename.className = 'short-filename';
                filename.textContent = short.filename;

                const actions1 = document.createElement('div');
                actions1.className = 'short-actions';

                const playBtn = document.createElement('button');
                playBtn.className = 'btn btn-secondary btn-play';
                playBtn.textContent = 'Play';
                playBtn.dataset.url = encodedPath;

                const downloadBtn = document.createElement('button');
                downloadBtn.className = 'btn btn-secondary btn-download';
                downloadBtn.textContent = 'Download';
                downloadBtn.dataset.url = encodedPath;
                downloadBtn.dataset.filename = short.filename;

                actions1.appendChild(playBtn);
                actions1.appendChild(downloadBtn);

                const actions2 = document.createElement('div');
                actions2.className = 'short-actions';

                const editBtn = document.createElement('button');
                editBtn.className = 'btn btn-secondary btn-edit';
                editBtn.textContent = 'Edit';
                editBtn.dataset.path = short.url_path;
                editBtn.dataset.filename = short.filename;
                editBtn.dataset.folderNumber = short.folder_number;
                editBtn.dataset.themeNumber = short.theme_number;
                editBtn.style.width = '100%';

                actions2.appendChild(editBtn);

                info.appendChild(title);
                info.appendChild(meta);
                info.appendChild(filename);
                info.appendChild(actions1);
                info.appendChild(actions2);

                itemDiv.appendChild(thumbnail);
                itemDiv.appendChild(info);

                container.appendChild(itemDiv);
            });

            // Add play button handlers
            container.querySelectorAll('.btn-play').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    // Find the video in this card and play/pause it
                    const card = btn.closest('.short-item');
                    const video = card.querySelector('video');
                    const playIcon = card.querySelector('.play-icon');
                    if (video) {
                        if (video.paused) {
                            stopAllVideos(video);
                            video.muted = false;
                            video.play();
                            if (playIcon) playIcon.style.display = 'none';
                        } else {
                            video.pause();
                            if (playIcon) playIcon.style.display = 'block';
                        }
                    }
                });
            });

            // Add download button handlers
            container.querySelectorAll('.btn-download').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const a = document.createElement('a');
                    a.href = btn.dataset.url;
                    a.download = btn.dataset.filename;
                    a.click();
                });
            });

            // Add edit button handlers
            container.querySelectorAll('.btn-edit').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const videoPath = btn.dataset.path;
                    const folderNumber = btn.dataset.folderNumber;
                    const themeNumber = btn.dataset.themeNumber;
                    window.open(`edit.html?video=${encodeURIComponent(videoPath)}&folder=${folderNumber}&theme=${themeNumber}`, '_blank');
                });
            });

            // Add click handler to play/pause video in thumbnail
            container.querySelectorAll('.short-thumbnail').forEach(thumbnail => {
                const video = thumbnail.querySelector('video');
                const playIcon = thumbnail.querySelector('.play-icon');

                // Toggle play/pause on click
                thumbnail.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (video.paused) {
                        stopAllVideos(video);
                        // Only reset to 0 if video hasn't started or has ended
                        if (video.currentTime === 0 || video.ended) {
                            video.currentTime = 0;
                        }
                        video.muted = false;
                        video.play();
                        if (playIcon) playIcon.style.display = 'none';
                    } else {
                        video.pause();
                        if (playIcon) playIcon.style.display = 'block';
                    }
                });

                // Show play icon when video ends
                video.addEventListener('ended', () => {
                    if (playIcon) playIcon.style.display = 'block';
                });
            });

            // Remove hover playback since click now controls it
            // Add click handler for the whole card (but not video or buttons)
            container.querySelectorAll('.short-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    // Don't trigger if clicking on video, buttons, or actions
                    if (e.target.closest('.short-thumbnail') ||
                        e.target.closest('.short-actions') ||
                        e.target.closest('button')) {
                        return;
                    }

                    // Toggle play/pause the video in the thumbnail
                    const video = item.querySelector('video');
                    const playIcon = item.querySelector('.play-icon');
                    if (video) {
                        if (video.paused) {
                            stopAllVideos(video);
                            // Only reset to 0 if video hasn't started or has ended
                            if (video.currentTime === 0 || video.ended) {
                                video.currentTime = 0;
                            }
                            video.muted = false;
                            video.play();
                            if (playIcon) playIcon.style.display = 'none';
                        } else {
                            video.pause();
                            if (playIcon) playIcon.style.display = 'block';
                        }
                    }
                });
            });
        }

        // Stop all videos except the one being played
        function stopAllVideos(exceptVideo) {
            document.querySelectorAll('.short-thumbnail video').forEach(video => {
                if (video !== exceptVideo) {
                    video.pause();
                    video.currentTime = 0;
                    video.muted = true;
                    const playIcon = video.parentElement.querySelector('.play-icon');
                    if (playIcon) playIcon.style.display = 'block';
                }
            });
        }

        // Refresh shorts button
        document.getElementById('refresh-shorts-btn').addEventListener('click', () => {
            loadShorts();
        });

        // Folder filter change
        document.getElementById('shorts-folder-filter').addEventListener('change', () => {
            filterAndDisplayShorts();
        });

        // Search input
        document.getElementById('shorts-search').addEventListener('input', () => {
            filterAndDisplayShorts();
        });

        // Display themes
        function displayThemes(data) {
            const panel = document.getElementById('themes-panel');
            panel.style.display = 'block';

            document.getElementById('selected-folder-title').textContent = data.title;
            document.getElementById('folder-stats').innerHTML = `
                <div class="stat">
                    <div class="stat-value">${data.themes.length}</div>
                    <div class="stat-label">Themes</div>
                </div>
            `;

            const container = document.getElementById('themes-list');
            container.innerHTML = data.themes.map(theme => `
                <label class="theme-item">
                    <input type="checkbox" class="theme-checkbox" data-theme="${theme.number}">
                    <div class="theme-content">
                        <div class="theme-header">
                            <span class="theme-number">Theme ${theme.number}</span>
                            <div class="theme-header-row">
                                ${theme.short_created ? '<span class="theme-created-badge">Short Created</span>' : `<span class="theme-duration">${theme.end}</span>`}
                                ${theme.short_created ? `<button class="theme-play-btn" data-video-path="${theme.short_info.path}">Play</button>` : ''}
                            </div>
                        </div>
                        <div class="theme-title">${theme.title}</div>
                        <div class="theme-time">${theme.start} - ${theme.end}</div>
                    </div>
                </label>
            `).join('');

            // Update create button state
            container.querySelectorAll('.theme-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', updateCreateButton);
            });

            // Add hover and click handlers for play buttons
            const tooltip = document.getElementById('tooltip');
            const videoModal = document.getElementById('video-modal');
            const videoPlayer = document.getElementById('video-player');

            container.querySelectorAll('.theme-play-btn').forEach(btn => {
                const videoPath = btn.dataset.videoPath;
                // Properly encode the URL path
                const pathParts = videoPath.split('/');
                const encodedPath = pathParts.map(part => encodeURIComponent(part)).join('/');
                const videoUrl = '/' + encodedPath.replace(/^\/+/, '');

                // Store encoded URL on the button
                btn.dataset.encodedUrl = videoUrl;

                // Hover tooltip
                btn.addEventListener('mouseenter', (e) => {
                    tooltip.textContent = videoPath;
                    tooltip.classList.add('show');
                    updateTooltipPosition(e);
                });

                btn.addEventListener('mousemove', updateTooltipPosition);

                btn.addEventListener('mouseleave', () => {
                    tooltip.classList.remove('show');
                });

                // Click to play video
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();

                    videoPlayer.src = videoUrl;
                    videoModal.classList.add('show');
                    videoPlayer.play();
                });
            });

            // Scroll to themes panel
            panel.scrollIntoView({ behavior: 'smooth' });
        }

        function updateTooltipPosition(e) {
            const tooltip = document.getElementById('tooltip');
            const x = e.clientX + 15;
            const y = e.clientY + 15;

            // Keep tooltip within viewport
            const maxX = window.innerWidth - tooltip.offsetWidth - 10;
            const maxY = window.innerHeight - tooltip.offsetHeight - 10;

            tooltip.style.left = Math.min(x, maxX) + 'px';
            tooltip.style.top = Math.min(y, maxY) + 'px';
        }

        // Update create shorts button
        function updateCreateButton() {
            const checked = document.querySelectorAll('.theme-checkbox:checked').length;
            const hasSelection = checked > 0;
            document.getElementById('create-shorts-btn').disabled = !hasSelection;
            document.getElementById('select-all-btn').disabled = !hasSelection;
            document.getElementById('deselect-all-btn').disabled = !hasSelection;
            document.getElementById('regenerate-btn').disabled = !hasSelection;
        }

        // Select/Deselect all
        document.getElementById('select-all-btn').addEventListener('click', () => {
            document.querySelectorAll('.theme-checkbox').forEach(cb => cb.checked = true);
            updateCreateButton();
        });

        document.getElementById('deselect-all-btn').addEventListener('click', () => {
            document.querySelectorAll('.theme-checkbox').forEach(cb => cb.checked = false);
            updateCreateButton();
        });

        // Process video
        document.getElementById('process-btn').addEventListener('click', async () => {
            const url = document.getElementById('url-input').value.trim();
            const file = document.getElementById('file-input').files[0];
            const model = 'small'; // Default model

            if (!url && !file) {
                showNotification('Please enter a URL or select a file', 'error');
                return;
            }

            const progressContainer = document.getElementById('process-progress');
            const progressText = document.getElementById('process-text');
            const cancelBtn = document.getElementById('cancel-process-btn');
            progressContainer.classList.add('active');
            document.getElementById('process-btn').disabled = true;
            cancelBtn.style.display = 'inline-block';

            try {
                const payload = { model };
                if (url) payload.url = url;
                if (file) payload.local_file = file.path || file.name;

                const response = await fetch(`${API_BASE}/process`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error('Failed to start processing');
                }

                const { task_id } = await response.json();
                currentTaskId = task_id;
                await monitorTask(task_id, (status) => {
                    progressText.textContent = `Processing: ${status.type}...`;
                });

                showNotification('Video processed successfully!', 'success');

                // Reset form
                document.getElementById('url-input').value = '';
                document.getElementById('file-input').value = '';

                // Switch to library tab
                setTimeout(() => {
                    document.querySelector('[data-tab="library"]').click();
                }, 1500);

            } catch (error) {
                showNotification('Error: ' + error.message, 'error');
            } finally {
                progressContainer.classList.remove('active');
                document.getElementById('process-btn').disabled = false;
                cancelBtn.style.display = 'none';
                currentTaskId = null;
            }
        });

        // Cancel process
        document.getElementById('cancel-process-btn').addEventListener('click', async () => {
            if (!currentTaskId) return;

            try {
                const response = await fetch(`${API_BASE}/task/${currentTaskId}/cancel`, {
                    method: 'POST'
                });

                if (response.ok) {
                    showNotification('Process cancelled', 'success');
                    currentTaskId = null;
                    document.getElementById('process-progress').classList.remove('active');
                    document.getElementById('process-btn').disabled = false;
                    document.getElementById('cancel-process-btn').style.display = 'none';
                }
            } catch (error) {
                showNotification('Error cancelling: ' + error.message, 'error');
            }
        });

        // Regenerate themes
        document.getElementById('regenerate-btn').addEventListener('click', async () => {
            if (!selectedFolder) return;

            const model = 'small'; // Default model
            const taskProgress = document.getElementById('task-progress');
            const taskProgressText = document.getElementById('task-progress-text');
            const cancelTaskBtn = document.getElementById('cancel-task-btn');

            taskProgress.style.display = 'block';
            taskProgressText.textContent = 'Regenerating themes...';
            cancelTaskBtn.style.display = 'inline-block';

            // Disable buttons
            document.getElementById('select-all-btn').disabled = true;
            document.getElementById('deselect-all-btn').disabled = true;
            document.getElementById('regenerate-btn').disabled = true;
            document.getElementById('create-shorts-btn').disabled = true;

            try {
                const response = await fetch(`${API_BASE}/regenerate-themes`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ folder_number: selectedFolder, model })
                });

                if (!response.ok) throw new Error('Failed to regenerate themes');

                const { task_id } = await response.json();
                currentTaskId = task_id;

                await monitorTask(task_id);

                // Reload themes
                selectFolder(selectedFolder);
                showNotification('Themes regenerated!', 'success');
            } catch (error) {
                showNotification('Error: ' + error.message, 'error');
            } finally {
                taskProgress.style.display = 'none';
                cancelTaskBtn.style.display = 'none';
                currentTaskId = null;
                updateCreateButton();
            }
        });

        // Create shorts
        document.getElementById('create-shorts-btn').addEventListener('click', async () => {
            if (!selectedFolder) return;

            const checkedThemes = Array.from(document.querySelectorAll('.theme-checkbox:checked'))
                .map(cb => parseInt(cb.dataset.theme));

            if (checkedThemes.length === 0) return;

            const taskProgress = document.getElementById('task-progress');
            const taskProgressText = document.getElementById('task-progress-text');
            const cancelTaskBtn = document.getElementById('cancel-task-btn');

            taskProgress.style.display = 'block';
            taskProgressText.textContent = 'Creating shorts...';
            cancelTaskBtn.style.display = 'inline-block';

            // Disable buttons
            document.getElementById('select-all-btn').disabled = true;
            document.getElementById('deselect-all-btn').disabled = true;
            document.getElementById('regenerate-btn').disabled = true;
            document.getElementById('create-shorts-btn').disabled = true;

            try {
                const response = await fetch(`${API_BASE}/create-shorts`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        folder_number: selectedFolder,
                        themes: checkedThemes
                    })
                });

                if (!response.ok) throw new Error('Failed to create shorts');

                const { task_id } = await response.json();
                currentTaskId = task_id;

                await monitorTask(task_id);

                // Reload folder list and themes to show green badges
                loadFolders();
                selectFolder(selectedFolder);
                showNotification('Shorts created!', 'success');
            } catch (error) {
                showNotification('Error: ' + error.message, 'error');
            } finally {
                taskProgress.style.display = 'none';
                cancelTaskBtn.style.display = 'none';
                currentTaskId = null;
                updateCreateButton();
            }
        });

        // Cancel task (for regenerate/create operations)
        document.getElementById('cancel-task-btn').addEventListener('click', async () => {
            if (!currentTaskId) return;

            try {
                const response = await fetch(`${API_BASE}/task/${currentTaskId}/cancel`, {
                    method: 'POST'
                });

                if (response.ok) {
                    showNotification('Task cancelled', 'success');
                    document.getElementById('task-progress').style.display = 'none';
                    document.getElementById('cancel-task-btn').style.display = 'none';
                    currentTaskId = null;
                    updateCreateButton();
                }
            } catch (error) {
                showNotification('Error cancelling: ' + error.message, 'error');
            }
        });

        // Monitor background task
        async function monitorTask(taskId, callback) {
            return new Promise((resolve, reject) => {
                const interval = setInterval(async () => {
                    try {
                        const response = await fetch(`${API_BASE}/task/${taskId}`);
                        const task = await response.json();

                        if (callback) callback(task);

                        if (task.status === 'completed') {
                            clearInterval(interval);
                            resolve(task.result);
                        } else if (task.status === 'failed') {
                            clearInterval(interval);
                            reject(new Error(task.error || 'Task failed'));
                        } else if (task.status === 'cancelled') {
                            clearInterval(interval);
                            reject(new Error('Task was cancelled'));
                        }
                    } catch (error) {
                        clearInterval(interval);
                        reject(error);
                    }
                }, 1000);
            });
        }

        // Show notification
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;

            // Scroll to notification
            notification.scrollIntoView({ behavior: 'smooth', block: 'center' });

            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Video modal controls
        document.getElementById('video-modal-close').addEventListener('click', () => {
            const videoModal = document.getElementById('video-modal');
            const videoPlayer = document.getElementById('video-player');
            videoPlayer.pause();
            videoPlayer.src = '';
            videoModal.classList.remove('show');
        });

        document.getElementById('video-modal').addEventListener('click', (e) => {
            if (e.target.id === 'video-modal') {
                const videoPlayer = document.getElementById('video-player');
                videoPlayer.pause();
                videoPlayer.src = '';
                e.target.classList.remove('show');
            }
        });

        // Initial load
        loadFolders();
    </script>
</body>
</html>
